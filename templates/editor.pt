<!DOCTYPE html>
<html lang="en">
<head>
	<title>pyWebTex</title>

	<style type='text/css'>
		body {
			background-color: #BBB;
		}
		.container-narrow {
			width: 1000px;
			margin: 0 auto;
		}

		#editor{
			width: 500px;
			height: 600px;
			float: left;
		}
		#pdfviewer{
			width: 500px;
			height: 600px;
			float: right;
		}

	</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
 <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script> 
  <script type="text/javascript" src="../lib/pdf.js/pdf.js"></script>

<link href="../lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<script src="../lib/bootstrap/js/bootstrap.js" ></script>
	<script>
		$(document).ready(function() {
			$("#myModal").modal({
				show: false
			});           
			$("#myModal .save-button").click(function(){
				$.post('../api/newfile', { filename: $('#myModal .filename').val()}, function(filename){
					editor.setValue("");
					window.location.href = filename;
				});
				$('#myModal').modal('hide');
			});

			$('.document-save').click(function(){
				var url = window.location.pathname;
				var filename = url.substring(url.lastIndexOf('/')+1);
				var content = editor.getValue(); 
				$.post('../api/save', { filename: filename, content : content}, function(filename){
					
				});
			});

			$('.document-compile').click(function(){
				var url = window.location.pathname;
				var filename = url.substring(url.lastIndexOf('/')+1);
				var content = editor.getValue(); 
				$.post('../api/compile', { filename: filename, content : content}, function(responseCode){
					PDFJS.getDocument('../build/' + filename.slice(0, -4) + '.pdf').then(function getPdfHelloWorld(_pdfDoc) {
    				  pdfDoc = _pdfDoc;
     				 renderPage(pageNum);
    				});
				});
			});
		});
	</script>
</head>
<body>




 
<!-- Modal -->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
    <h3 id="myModalLabel">New Document</h3>
  </div>
  <div class="modal-body">
    <p>Create a new document</p>
    <input class="filename" type="text" >

  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="save-button btn btn-primary">Save changes</button>
  </div>
</div>

<div class="container-narrow">

  <div class="masthead">

	<h3 class="muted">pyWebTeX</h3>
	<div class="navbar">
	  <div class="navbar-inner">
		<div class="container">
		  <ul class="nav">
			<li class="active"><a href="#">Home</a></li>
			<li><a href="#myModal"  data-toggle="modal">New Document</a></li>
			<li><a class="document-compile" href="#">Compile</a></li>
			<li><a href="#">Settings</a></li>
			<li><a class="document-save" href="#">Save</a></li>
		  </ul>
		</div>
	  </div>
	</div><!-- /.navbar -->
  </div>

  <hr>

 <!-- <div class="jumbotron">
	<h1>Super awesome marketing speak!</h1>
	<p class="lead">

	</p>
	<a class="btn btn-large btn-success" href="#">Sign up today</a>
  </div>

  <hr>
-->

  <div class="row-fluid marketing">

	  <h4>Subheading</h4>

	<div id="editor">${editorcontent}</div>
	<div id="pdfviewer">
		<div>
		    <button id="prev" onclick="goPrevious()">Previous</button>
		    <button id="next" onclick="goNext()">Next</button>
		    &nbsp; &nbsp;
		    <span>Page: <span id="page_num"></span> / <span id="page_count"></span></span>
	 	 </div>
		  <div>
		    <canvas id="the-canvas" style="border:1px solid black"></canvas>
		  </div>
	</div>
  </div>
  <hr>

  <div class="footer">
	<p>&copy; Martin Zellner, 2013</p>
  </div>

</div>
<script src="../lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
	var editor = ace.edit("editor");
	editor.setTheme("ace/theme/github");
	editor.getSession().setMode("ace/mode/latex");
</script>

<script type="text/javascript">
    //
    // NOTE: 
    // Modifying the URL below to another server will likely *NOT* work. Because of browser
    // security restrictions, we have to use a file server with special headers
    // (CORS) - most servers don't support cross-origin browser requests.
    //
    var url = 'http://cdn.mozilla.net/pdfjs/tracemonkey.pdf';

    //
    // Disable workers to avoid yet another cross-origin issue (workers need the URL of
    // the script to be loaded, and currently do not allow cross-origin scripts)
    //
    PDFJS.disableWorker = true;

    var pdfDoc = null,
        pageNum = 1,
        scale = 0.8,
        canvas = document.getElementById('the-canvas'),
        ctx = canvas.getContext('2d');

    //
    // Get page info from document, resize canvas accordingly, and render page
    //
    function renderPage(num) {
      // Using promise to fetch the page
      pdfDoc.getPage(num).then(function(page) {
        var viewport = page.getViewport(scale);
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        // Render PDF page into canvas context
        var renderContext = {
          canvasContext: ctx,
          viewport: viewport
        };
        page.render(renderContext);
      });

      // Update page counters
      document.getElementById('page_num').textContent = pageNum;
      document.getElementById('page_count').textContent = pdfDoc.numPages;
    }

    //
    // Go to previous page
    //
    function goPrevious() {
      if (pageNum <= 1)
        return;
      pageNum--;
      renderPage(pageNum);
    }

    //
    // Go to next page
    //
    function goNext() {
      if (pageNum >= pdfDoc.numPages)
        return;
      pageNum++;
      renderPage(pageNum);
    }

    //
    // Asynchronously download PDF as an ArrayBuffer
    //
    PDFJS.getDocument(url).then(function getPdfHelloWorld(_pdfDoc) {
      pdfDoc = _pdfDoc;
      renderPage(pageNum);
    });
  </script>  


</body>
</html>